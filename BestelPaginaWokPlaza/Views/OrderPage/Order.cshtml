@model BestelPaginaWokPlaza.Models.AdminViewModel
@{
    ViewData["Title"] = "Bestelpagina";
}
<link rel="stylesheet" href="~/css/OrderPage.css" />

<h1 class="title">Bestelpagina van Wok Plaza</h1>

<div class="container">
    <div class="row">
        <div class="col-lg-3 navigation-column">
            <h5>Menukaart</h5>

            <nav class="sidebar-nav">
                <div class="navbar navbar-default item-menu" role="navigation">
                    <div class="navbar-collapse sidebar-navbar-collapse">
                        <ul class="nav navbar-nav">
                            @foreach (var category in Model.categoryList)
                            {
                                <li class="nav-item"><a href="#menu-@category.Value">@category.Text</a></li>
                            }
                        </ul>
                    </div>
                </div>
            </nav>

        </div>
        <div class="col-lg-6 dish-column">
            @foreach (var category in Model.categoryList)
            {
                <table class="category-item">
                    <tr class="category-header">
                        <th class="category-name" id="menu-@category.Value">@category.Text</th>
                    </tr>

                    @foreach (DishModel dish in Model.dishList)
                    {
                        if (Convert.ToInt32(category.Value) == dish.category_id)
                        {
                            <tr class="dish-item">
                                <td class="dish-content">
                                    <input class="dish-id" type="hidden" value="@dish.id"/>
                                    <h3 class="dish-name">@dish.name</h3>
                                    <button type="button" class="dish-price btn btn-primary" onclick="AddDish(event)">&#8364; @dish.price +</button>
                                    <span class="dish-description">@dish.description</span>
                                </td>
                            </tr>
                        }
                    }
                </table>
            }
        </div>
        <partial name="Partials/_ShoppingCart" />
        
    </div>
</div>

<script>

    function appendShoppingCart(result) {
        const winkelwagen = document.querySelector(".shoppingCart");
        winkelwagen.innerHTML = "";
        if (result != null) {
            result.reverse();

            result.forEach(item => {
                console.log(document.querySelector(".shoppingCart #dish-" + item["id"]));
                if (document.querySelector(".shoppingCart #dish-" + item["id"]) == null) {
                    var dishDiv = document.createElement("div");
                    dishDiv.className = 'shopping-cart-dish';
                    dishDiv.id = "dish-" + item["id"];
                    winkelwagen.append(dishDiv);

                    var dishAantal = document.createElement("div");
                    dishAantal.innerHTML = result.filter(dish => dish["id"] == item["id"]).length + "x";
                    dishAantal.className = 'shopping-cart-dish-aantal';
                    dishDiv.append(dishAantal);

                    var dishName = document.createElement("div");
                    dishName.innerHTML = item["name"];
                    dishName.className = 'shopping-cart-dish-name';
                    dishDiv.append(dishName);

                    var dishPrice = document.createElement("div");
                    var dishTotalPrice = result.filter(dish => dish["id"] == item["id"]).length * item["price"];
                    dishPrice.innerHTML = "&#8364; " + dishTotalPrice.toFixed(2);
                    dishPrice.className = 'shopping-cart-dish-price';
                    dishDiv.append(dishPrice);

                    var dishButton = document.createElement("button");
                    dishButton.className = "shopping-cart-dish-button btn btn-sm btn-danger";
                    dishButton.addEventListener("click", function (e) {
                        $.post("/ShoppingCart/DeleteFromCart", { id: item["id"] }, function (result) {
                            if (parseInt(dishDiv.querySelector(".shopping-cart-dish-aantal").innerHTML) <= 1) {
                                document.getElementById("dish-" + item["id"]).remove();
                                $.get("/ShoppingCart/CalcTotalPrice", function (result) {
                                    document.getElementById("total-price").innerHTML = "&#8364; " + parseFloat(result).toFixed(2);
                                });
                            }
                            else {
                                dishDiv.querySelector(".shopping-cart-dish-aantal").innerHTML = parseInt(dishDiv.querySelector(".shopping-cart-dish-aantal").innerHTML) - 1 + "x";
                                let price = dishDiv.querySelector(".shopping-cart-dish-price").innerHTML.replace("€", "");
                                dishDiv.querySelector(".shopping-cart-dish-price").innerHTML = "&#8364; " + (price - item["price"]).toFixed(2);

                                $.get("/ShoppingCart/CalcTotalPrice", function (result) {
                                    document.getElementById("total-price").innerHTML = "&#8364; " + parseFloat(result).toFixed(2);
                                });
                            }
                        });
                        
                    })
                    dishDiv.append(dishButton);

                    var minusIcon = document.createElement("i");
                    minusIcon.className = 'fa fa-minus shopping-cart-button-icon';
                    dishButton.append(minusIcon);

                }
            });
        }
    }

    const AddDish = (e) => {
        const target = e.target.parentElement
        const dishId = target.querySelector(".dish-id").value;
        console.log(dishId);
        $.post("/ShoppingCart/AddToCart", { id: dishId }, function (result) {
            console.log(result);
            $.get("/ShoppingCart/CalcTotalPrice", function (result) {
                document.getElementById("total-price").innerHTML = "&#8364; " + parseFloat(result).toFixed(2);
            });
        });

        setTimeout(function() {
            $.get("/ShoppingCart/GetAllShoppingCartItems", function (result) {
                console.log(result);
                appendShoppingCart(result);
            });
        }, 100);
    }
   
</script>


